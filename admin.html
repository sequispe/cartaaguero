<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Tilo Caf√© Ag√ºero</title>
  <style>
    body {
      background: #f4ece6;
      margin: 0;
      font-family: Arial, sans-serif;
      padding: 25px;
    }

    h1 {
      text-align: center;
      color: #5e4234;
      margin-bottom: 20px;
    }

    /* BUSCADOR */
    #search {
      width: 70%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #b8a59a;
      margin-bottom: 15px;
    }

    button {
      background: #806250;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: .3s;
    }

    button:hover { background: #a07863; }

    /* FORMULARIO */
    #formBox {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #c8b8ac;
    }

    #preview {
      max-width: 120px;
      margin-top: 6px;
      border-radius: 8px;
    }

    /* TABLA */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    th {
      background: #806250;
      color: white;
      padding: 10px;
      text-align: left;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #e5d8cf;
    }

    img {
      width: 60px;
      border-radius: 6px;
    }

    /* NOTIFICACI√ìN */
    #notif {
      display: none;
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #5e4234;
      padding: 12px 18px;
      color: white;
      border-radius: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Panel de Administraci√≥n - Tilo Caf√© Ag√ºero</h1>

<!-- TOKEN -->
<div style="margin-bottom:15px;">
  <input type="password" id="token" placeholder="Peg√° tu token" style="width:60%; padding:8px;">
  <button onclick="saveToken()">Guardar Token</button>
  <button onclick="clearToken()">Borrar</button>
  <p id="tokMsg"></p>
</div>

<!-- BUSCADOR -->
<input type="text" id="search" placeholder="Buscar producto..." oninput="buscar()">

<!-- BOT√ìN MOSTRAR FORM -->
<button onclick="toggleForm()">Agregar producto ‚ûï</button>

<!-- FORMULARIO -->
<div id="formBox">
  <h3 id="formTitle">Agregar producto</h3>

  <input type="hidden" id="editIndex">

  <label>Nombre</label>
  <input type="text" id="nombre" required>

  <label>Descripci√≥n</label>
  <textarea id="descripcion" required></textarea>

  <label>Precio</label>
  <input type="number" id="precio" required>

  <label>Imagen (img/foto.jpg)</label>
  <input type="text" id="imagen" oninput="preview()" required>
  <img id="preview">

  <label>Categor√≠a</label>
  <input list="cats" type="text" id="categoria" required>
  <datalist id="cats"></datalist>

  <button onclick="guardar()">Guardar</button>
</div>

<!-- TABLA -->
<table>
  <thead>
    <tr>
      <th>Img</th>
      <th>Nombre</th>
      <th>Descripci√≥n</th>
      <th>Categor√≠a</th>
      <th>Precio</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tb"></tbody>
</table>

<!-- NOTIFICACI√ìN -->
<div id="notif"></div>

<script>
const USER = "cholose10";
const REPO = "cartaaguero";
const FILE = "productos.json";

let productos = [];

/* TOKEN */
function saveToken(){
  let t = document.getElementById("token").value.trim();
  if(t){
    localStorage.setItem("token_tilo", t);
    document.getElementById("tokMsg").innerText = "üîê Token guardado.";
    document.getElementById("token").value = "";
  }
}
function clearToken(){
  localStorage.removeItem("token_tilo");
  document.getElementById("tokMsg").innerText = "‚ö†Ô∏è Token borrado.";
}
function getToken(){ return localStorage.getItem("token_tilo"); }

/* LOAD */
async function load(){
  const url = `https://raw.githubusercontent.com/${USER}/${REPO}/main/${FILE}`;
  const res = await fetch(url);
  productos = await res.json();
  render(productos);
  cargarCategorias();
}
load();

/* RENDER */
function render(list){
  const tb = document.getElementById("tb");
  tb.innerHTML = "";

  list.forEach((p,i) => {
    tb.innerHTML += `
      <tr>
        <td><img src="${p.imagen}"></td>
        <td>${p.nombre}</td>
        <td>${p.descripcion}</td>
        <td>${p.categoria}</td>
        <td>$${p.precio}</td>
        <td>
          <button onclick="editar(${i})">Editar</button>
          <button onclick="eliminar(${i})">Eliminar</button>
        </td>
      </tr>
    `;
  });
}

/* BUSCADOR */
function buscar(){
  const q = document.getElementById("search").value.toLowerCase();
  const f = productos.filter(p =>
    p.nombre.toLowerCase().includes(q) ||
    p.descripcion.toLowerCase().includes(q) ||
    p.categoria.toLowerCase().includes(q)
  );
  render(f);
}

/* PREVIEW IMG */
function preview(){
  document.getElementById("preview").src =
    document.getElementById("imagen").value;
}

/* TOGGLE FORM */
function toggleForm(){
  const box = document.getElementById("formBox");
  box.style.display = box.style.display === "block" ? "none" : "block";
}

/* CATEGOR√çAS */
function cargarCategorias(){
  const cats = [...new Set(productos.map(p => p.categoria))].sort();
  const dat = document.getElementById("cats");
  dat.innerHTML = "";
  cats.forEach(c => {
    dat.innerHTML += `<option value="${c}">`;
  });
}

/* GUARDAR */
async function guardar(){
  const prod = {
    nombre: nombre.value,
    descripcion: descripcion.value,
    precio: parseFloat(precio.value),
    imagen: imagen.value,
    categoria: categoria.value
  };

  let idx = document.getElementById("editIndex").value;

  if(idx === "")
    productos.push(prod);
  else
    productos[idx] = prod;

  await saveGitHub(JSON.stringify(productos, null, 2));

  render(productos);
  cargarCategorias();

  notif("Guardado correctamente ‚úîÔ∏è");

  document.getElementById("formBox").style.display = "none";
  document.getElementById("editIndex").value = "";
}

/* EDITAR */
function editar(i){
  const p = productos[i];

  nombre.value = p.nombre;
  descripcion.value = p.descripcion;
  precio.value = p.precio;
  imagen.value = p.imagen;
  categoria.value = p.categoria;
  preview();
  document.getElementById("editIndex").value = i;

  document.getElementById("formBox").style.display = "block";
  document.getElementById("formTitle").innerText = "Editar producto";
}

/* ELIMINAR */
async function eliminar(i){
  if(!confirm("¬øEliminar producto?")) return;

  productos.splice(i,1);
  render(productos);

  await saveGitHub(JSON.stringify(productos,null,2));
  notif("Producto eliminado ‚ùå");
}

/* GUARDAR EN GITHUB */
async function saveGitHub(content){
  const token = getToken();
  if(!token){ notif("Falta token ‚ùå"); return; }

  const api = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`;

  const get = await fetch(api, {
    headers: { Authorization: "token " + token }
  });

  const data = await get.json();

  const res = await fetch(api, {
    method: "PUT",
    headers: {
      Authorization: "token " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Admin update",
      content: btoa(unescape(encodeURIComponent(content))),
      sha: data.sha
    })
  });

  return res.ok;
}

/* NOTIF */
function notif(msg){
  const n = document.getElementById("notif");
  n.innerText = msg;
  n.style.display = "block";
  setTimeout(()=> n.style.display="none", 2500);
}
</script>

</body>
</html>
