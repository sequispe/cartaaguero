<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Carta - Tilo CafÃ© Aguero (Sincroniza precios ES/EN/PT)</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f7f3f0;color:#333}
    h1{text-align:center;color:#806250;margin-bottom:10px}
    .topRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="text"], input[type="password"], textarea{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box}
    button{background:#806250;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#5c8a50}
    button.danger{background:#c0392b}
    form{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:none}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#806250;color:#fff}
    img.mini{max-width:60px;border-radius:6px}
    #guardarTodos{position:fixed;top:18px;right:18px;z-index:1200;padding:10px 14px;background:#a07b68;color:#fff;border-radius:8px}
    .small{font-size:13px;color:#666}
    .rowActions{display:flex;gap:6px}
    .previewImg{max-width:120px;margin-top:8px;border-radius:6px}
    .toast{position:fixed;top:24px;right:24px;z-index:2000;padding:12px 16px;border-radius:8px;color:white;font-weight:600;opacity:0;transition:.25s}
    .toast.show{opacity:1}
    .toast.ok{background:#2ecc71}
    .toast.info{background:#3498db}
    .toast.err{background:#e74c3c}
  </style>
</head>

<body>

<h1>Admin Carta â€” Tilo CafÃ© Aguero</h1>

<button id="guardarTodos" onclick="guardarTodosLosPrecios()">ðŸ’¾ Guardar TODOS los cambios</button>

<table>
<thead>
<tr>
  <th>Imagen</th>
  <th>Nombre</th>
  <th>DescripciÃ³n</th>
  <th>CategorÃ­a</th>
  <th>Precio</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
/* ================= CONFIG ================= */
const USERNAME = "tilo-restocafe";
const REPO = "cartaaguero";
const BRANCH = "main";

const MAIN_JSON = "productos.json";
const EN_JSON   = "productos-en.json";
const PT_JSON   = "productos-port.json";

let productos = [];

/* ================= UTIL ================= */
function showToast(msg,type='ok'){
  const d=document.createElement('div');
  d.className='toast '+type;
  d.textContent=msg;
  document.body.appendChild(d);
  setTimeout(()=>d.classList.add('show'),50);
  setTimeout(()=>d.remove(),3000);
}

function sanitizePrice(v){
  return String(v||'').replace(/[^\d]/g,'');
}

function getToken(){
  return localStorage.getItem('github_token');
}

/* ================= LOAD ================= */
async function loadProducts(){
  const r=await fetch(`https://raw.githubusercontent.com/${USERNAME}/${REPO}/${BRANCH}/${MAIN_JSON}`);
  productos=await r.json();
  render();
}

/* ================= RENDER ================= */
function render(){
  const tb=document.getElementById('tbody');
  tb.innerHTML='';
  productos.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><img class="mini" src="${p.imagen||''}"></td>
      <td><input value="${p.nombre||''}" oninput="p.nombre=this.value"></td>
      <td><input value="${p.descripcion||''}" oninput="p.descripcion=this.value"></td>
      <td><input value="${p.categoria||''}" oninput="p.categoria=this.value"></td>
      <td><input value="${p.precio||''}" oninput="p.precio=this.value"></td>
      <td><button onclick="guardarFilaPorId('${p.id}')">Guardar</button></td>
    `;
    tb.appendChild(tr);
  });
}

/* ================= GITHUB ================= */
async function githubGetFileInfo(path){
  const r=await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}?ref=${BRANCH}`,{
    headers:{Authorization:'token '+getToken()}
  });
  return r.json();
}

async function githubPutFile(path,content,msg,sha){
  await fetch(`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`,{
    method:'PUT',
    headers:{
      Authorization:'token '+getToken(),
      'Content-Type':'application/json'
    },
    body:JSON.stringify({
      message:msg,
      content:btoa(unescape(encodeURIComponent(content))),
      sha,
      branch:BRANCH
    })
  });
}

/* ================= SAVE ES ================= */
async function saveMainJson(){
  const info=await githubGetFileInfo(MAIN_JSON);
  await githubPutFile(
    MAIN_JSON,
    JSON.stringify(productos,null,2),
    'Actualiza productos',
    info.sha
  );
}
  
<script>
/**********************************************************
 * ðŸ”¥ NUEVO: Sincronizar precio + imagen + id a EN / PT
 * NO toca nombres ni descripciones
 **********************************************************/
async function syncCommonFieldsToLangs(){

  const token = getToken();
  if(!token){
    showToast('Token requerido para sincronizar EN/PT', 'err', 4000);
    return;
  }

  // Base desde ES
  const baseById = {};
  productos.forEach(p => {
    if(p.id){
      baseById[p.id] = {
        precio: sanitizePrice(p.precio),
        imagen: p.imagen || ''
      };
    }
  });

  async function processFile(filename, idioma){

    let info;
    try{
      info = await githubGetFileInfo(filename);
    }catch(e){
      return;
    }

    const raw = info.content.replace(/\n/g,'');
    const decoded = decodeURIComponent(escape(atob(raw)));
    let arr = JSON.parse(decoded);

    let changed = false;

    arr.forEach(item => {
      if(item.id && baseById[item.id]){
        const base = baseById[item.id];

        if(idioma === 'EN'){
          if(item.price !== base.precio){
            item.price = base.precio;
            changed = true;
          }
          if(item.image !== base.imagen){
            item.image = base.imagen;
            changed = true;
          }
        }

        if(idioma === 'PT'){
          if(item.preco !== base.precio){
            item.preco = base.precio;
            changed = true;
          }
          if(item.imagem !== base.imagen){
            item.imagem = base.imagen;
            changed = true;
          }
        }
      }
    });

    if(changed){
      const latest = await githubGetFileInfo(filename);
      await githubPutFile(
        filename,
        JSON.stringify(arr, null, 2),
        'Sincroniza precio e imagen desde productos.json',
        latest.sha
      );
    }
  }

  await processFile(EN_JSON, 'EN');
  await processFile(PT_JSON, 'PT');
}
</script>
  
<script>
/**********************************************************
 * CONEXIÃ“N FINAL
 * Guarda ES + sincroniza EN / PT
 **********************************************************/

async function guardarFilaPorId(id){
  try{
    const p = productos.find(x => x.id === id);
    if(!p){
      showToast('Producto no encontrado', 'err');
      return;
    }

    // Normalizar precio
    p.precio = sanitizePrice(p.precio);

    // 1ï¸âƒ£ Guardar productos.json (ES)
    await saveMainJson(productos, `Actualiza producto ${p.id}`);

    // 2ï¸âƒ£ Sincronizar precios (funciÃ³n original)
    await syncPricesToLangs();

    // 3ï¸âƒ£ ðŸ”¥ Sincronizar precio + imagen + id (funciÃ³n nueva)
    await syncCommonFieldsToLangs();

    showToast('Producto guardado y sincronizado (ES / EN / PT)', 'ok', 3000);
    render(productos);

  }catch(e){
    console.error(e);
    showToast('Error al guardar producto', 'err', 5000);
  }
}


async function guardarTodosLosPrecios(){
  try{

    // Normalizar precios
    productos = productos.map(p => ({
      ...p,
      precio: sanitizePrice(p.precio)
    }));

    // 1ï¸âƒ£ Guardar ES
    await saveMainJson(productos, 'Guardar TODOS los productos');

    // 2ï¸âƒ£ Sincronizar precios
    await syncPricesToLangs();

    // 3ï¸âƒ£ ðŸ”¥ Sincronizar precio + imagen + id
    await syncCommonFieldsToLangs();

    showToast('Todos los productos sincronizados (ES / EN / PT)', 'ok', 3500);
    render(productos);

  }catch(e){
    console.error(e);
    showToast('Error al guardar todos los productos', 'err', 6000);
  }
}

/**********************************************************
 * INIT
 **********************************************************/
document.addEventListener('DOMContentLoaded', () => {
  loadProducts();
});
</script>

</body>
</html>
