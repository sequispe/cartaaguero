<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Carta - Tilo Café Agüero</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f3f0; color:#333; }
    h1 { text-align:center; color:#806250; }
    #toggleForm { background:#806250; color:white; padding:10px 15px; border-radius:6px; cursor:pointer; margin-bottom:15px; }
    form { display:none; background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; }
    input, textarea { width:100%; padding:8px; margin:7px 0; border-radius:6px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; background:white; }
    th,td { border:1px solid #ddd; padding:8px; }
    th { background:#806250; color:white; }
    button { background:#806250; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn-delete { background:#c0392b; }
    #preview { max-width:100px; margin-top:5px; border-radius:6px; }
    #hoverPreview { position: fixed; top: 0; left: 0; width: 220px; display:none; border:2px solid #806250; border-radius:10px; background:#fff; z-index:9999; box-shadow:0 0 10px rgba(0,0,0,0.3); padding:6px; }
    td input, td textarea { width:95%; }
    td img.mini-img { cursor: pointer; }
  </style>
</head>
<body>
  <h1>Panel de Administración</h1>

  <div>
    <label>Token:</label>
    <input type="password" id="token" placeholder="Pegar token">
    <button onclick="saveToken()">Guardar</button>
    <button onclick="clearToken()">Borrar</button>
    <p id="tokenStatus"></p>
  </div>

  <input id="search" placeholder="Buscar..." oninput="filterProducts()">

  <button id="toggleForm" onclick="toggleForm()">+ Agregar producto</button>

  <form id="form">
    <input type="hidden" id="editIndex">
    <label>Nombre</label>
    <input id="nombre">

    <label>Descripción</label>
    <textarea id="descripcion"></textarea>

    <label>Precio</label>
    <input id="precio">

    <label>Imagen (img/...)</label>
    <input id="imagen" oninput="previewImage()">
    <img id="preview">

    <label>Categoría</label>
    <input id="categoria">

    <button type="button" onclick="guardarFormulario()">Guardar</button>
  </form>

  <table>
    <thead><tr>
      <th>Imagen</th><th>Nombre</th><th>Descripción</th><th>Categoría</th><th>Precio</th><th>Acciones</th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
const USERNAME="cholose10", REPO="cartaaguero";
const FILES=["productos.json","productos-en.json","productos-port.json"];
let productos=[];

function toggleForm(){ const f=document.getElementById('form'); f.style.display = f.style.display==='none' || f.style.display==='' ? 'block':'none'; }
function saveToken(){ const t=document.getElementById('token').value; localStorage.setItem('github_token',t); tokenStatus.innerText='Token guardado'; }
function clearToken(){ localStorage.removeItem('github_token'); tokenStatus.innerText='Token borrado'; }
function getToken(){ return localStorage.getItem('github_token'); }

async function loadProducts(){
  try{
    const url=`https://raw.githubusercontent.com/${USERNAME}/${REPO}/main/productos.json`;
    const r=await fetch(url);
    productos=await r.json(); render(productos);
  }catch(e){ alert('Error cargando productos'); }
}

function render(lista){
  const tb=document.getElementById('tbody'); tb.innerHTML='';
  lista.forEach((p,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>
          <img src="${p.imagen}" class="mini-img" style="max-width:60px; margin-bottom:6px;">
          <input value="${p.imagen}" oninput="editField(${i}, 'imagen', this.value)">
        </td>
        <td><input value="${p.nombre}" oninput="editField(${i}, 'nombre', this.value)"></td>
        <td><textarea oninput="editField(${i}, 'descripcion', this.value)">${p.descripcion}</textarea></td>
        <td><input value="${p.categoria}" oninput="editField(${i}, 'categoria', this.value)"></td>
        <td><input value="${p.precio}" oninput="editField(${i}, 'precio', this.value)"></td>
        <td>
          <button onclick="guardarFila(${i})">Guardar</button>
          <button class="btn-delete" onclick="del(${i})">Eliminar</button>
        </td>
      </tr>`;
  });
}

function editField(i, campo, valor){ productos[i][campo] = valor; }

function generarID(){
  let max = 0;
  productos.forEach(p=>{
    if(p.id && p.id.startsWith("prod")){
      const n=parseInt(p.id.replace("prod",""));
      if(n>max) max=n;
    }
  });
  return "prod" + String(max+1).padStart(4,"0");
}

async function guardarFila(i){ if(await guardarEnJSONs()) animarFila(i); }

async function guardarFormulario(){
  const i=document.getElementById('editIndex').value;
  const obj={ nombre:nombre.value, descripcion:descripcion.value, precio:precio.value, imagen:imagen.value, categoria:categoria.value };
  if(!obj.id) obj.id = generarID();
  if(i==='' || i===null) productos.push(obj); else productos[i]=obj;
  await guardarEnJSONs(); loadProducts(); alert('Guardado');
}

async function del(i){ if(confirm('¿Eliminar?')){ productos.splice(i,1); await guardarEnJSONs(); loadProducts(); } }

async function guardarEnJSONs(){
  const token=getToken(); if(!token){ alert('Falta token'); return false; }
  const contentES = JSON.stringify(productos,null,2);

  for(const file of FILES){ await subir(file, contentES, token); }
  alert('Cambios guardados en los 3 JSON');
  return true;
}

async function subir(file, content, token){
  const api=`https://api.github.com/repos/${USERNAME}/${REPO}/contents/${file}`;
  const r=await fetch(api); const j=await r.json();
  await fetch(api,{
    method:"PUT",
    headers:{"Content-Type":"application/json","Authorization":`token ${token}`},
    body:JSON.stringify({message:"update", content:btoa(unescape(encodeURIComponent(content))), sha:j.sha})
  });
}

function previewImage(){ preview.src=imagen.value; }
function filterProducts(){ const t=search.value.toLowerCase(); render(productos.filter(p=>p.nombre.toLowerCase().includes(t) || p.descripcion.toLowerCase().includes(t) || p.categoria.toLowerCase().includes(t))); }
function animarFila(i){ const filas=document.querySelectorAll('#tbody tr'); if(filas[i]){ filas[i].style.background="#d1f2d1"; setTimeout(()=>filas[i].style.background="",500); }}

loadProducts();
</script>
<img id="hoverPreview" />
</body>
</html>
